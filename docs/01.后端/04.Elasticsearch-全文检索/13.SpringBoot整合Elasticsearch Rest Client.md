---
title: SpringBoot整合Elasticsearch Rest Client
date: 2020-11-26 15:23:10
permalink: /pages/9739e8/
categories:
  - 后端
  - Elasticsearch-全文检索
tags:
  - SpringBoot
  - Elasticsearch
  - Client
---

## 前言

前面通过nginx搭建了ik分词器的自定义词库，接下来就用SpringBoot整合Elasticsearch Rest Client。

当在电商商品页面场景时，需要发请求到Spinrgboot，Spirngoobt操作ES，再用ES来检索商品，将处理的结果返回到前端页面。



对于Java来操作ES有两种方式：

- 9300 TCP。

  （ES集群节点之间通信也是用9300端口）如果使用这种方式，就需要与ES建立一个常链接，而支持这种操作需要用`spring-data-elasticsearch-transport-api.jar`，包括官方的`elasticsearch.jar`也支持这种操作。

  但是不建议使用9300 TCP端口来操作，因为Spirngboot版本不同，transport-api.jar不同，不能适配es版本，而且连官方也说，elasticsearch 7.x已经不建议使用，8.x版本以上都要废弃使用`spring-data-elasticsearch-transport-api.jar`来操作ES

  > spring-data-elasticsearch-transport-api.jar目前最多支持到elasticsearch 6.3.8版本

- 9200 HTTP

就是给ES发送请求，市面上有许多方式：

1. JestClinet

非官方，更新慢，[maven仓库](https://mvnrepository.com/artifact/io.searchbox/jest)最近一次更新是2018年的，而且最多支持elasticsearch 6.3.1版本。

2. RestTemplate

模拟法HTTP请求，ES很多操作需要自己封装，如果自己操作`Query DSL`就需要自己封装，比较麻烦。

3. HttpClient

同上

4. Elasticssearch-Rest-Client

官方的RestClient，封装了ES操作，API层次分明，上手简单。而且还支持Java,Javascript,Go,Ruby,Python,.net,PHP等等各种语言来操作

所以优先选择官方的RestClient。

> 为什么不用js来给ES发送请求？

因为安全问题，ES一般部署在集群服务器上，端口不对外暴露，一旦保留了容易被人恶意利用。而且如果用JS发送请求给ES，根本不需要用到RestClient，直接发送请求就可以了。



## Java REST Client

> The Java REST Client comes in 2 flavors:
>
> - [Java Low Level REST Client](https://www.elastic.co/guide/en/elasticsearch/client/java-rest/current/java-rest-low.html): the official low-level client for Elasticsearch. It allows to communicate with an Elasticsearch cluster through http. Leaves requests marshalling and responses un-marshalling to users. It is compatible with all Elasticsearch versions.
> - [Java High Level REST Client](https://www.elastic.co/guide/en/elasticsearch/client/java-rest/current/java-rest-high.html): the official high-level client for Elasticsearch. Based on the low-level client, it exposes API specific methods and takes care of requests marshalling and responses un-marshalling.

Elasticssearch-Rest-Client，分高低阶两种：

- [Java Low Level REST Client](https://www.elastic.co/guide/en/elasticsearch/client/java-rest/current/java-rest-low.html)
- [Java High Level REST Client](https://www.elastic.co/guide/en/elasticsearch/client/java-rest/current/java-rest-high.html)

他们的关系就类似于`mybatis`（高阶）与`JDBC`（低阶）的关系一样，mybatis封装jdbc，再来操作数据库就简单了，所以要用[Java High Level REST Client](https://www.elastic.co/guide/en/elasticsearch/client/java-rest/current/java-rest-high.html)。



## 实现方式

现在直接用idea新建一个独立项目来检索ES。

### 创建独立项目

- new moudle，选择spring初始化向导

![image-20201126155130059](https://raw.githubusercontent.com/SaulJWu/images/main/20201126155150.png)

<img src="https://raw.githubusercontent.com/SaulJWu/images/main/20201126160113.png" alt="image-20201126160059628" style="zoom:50%;" />

- 组件 选Web下的SpringWeb



### 导入maven依赖

参考[官方文档](https://www.elastic.co/guide/en/elasticsearch/client/java-rest/current/java-rest-high-getting-started-maven.html)

~~~xml
<dependency>
    <groupId>org.elasticsearch.client</groupId>
    <artifactId>elasticsearch-rest-high-level-client</artifactId>
    <version>7.10.0</version>
</dependency>
~~~

> 这里改为当前ES的版本，不一定是7.10.0

导入依赖完成，查看一下

![image-20201126164244395](https://raw.githubusercontent.com/SaulJWu/images/main/20201126164244.png)		

这里发现，Springboot默认导入的ES版本与我虚拟机中ES版本的不一致。所以需要在search微服务的pom文件指定版本，保持和虚拟机中的一致。

~~~xml
<properties>
    <java.version>1.8</java.version>
    <elasticsearch.version>7.6.2</elasticsearch.version>
</properties>
~~~

改完后，刷新maven，查看ES版本是否一致。